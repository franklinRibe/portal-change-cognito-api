trigger:
  branches:
    include:
      - main

pool:
  name: eks-development
  vmImage: ubuntu-latest

variables:
  nodeVersion: '20.x'

  imageRepository: 'portal-backoffice-frontend'
  containerRegistryServiceConnection: 'aws-default-ecr'

  dockerfilePath: 'Dockerfile'

  shortSha: $[ substring( variables['Build.SourceVersion'], 0, 7 ) ]

  imageTag: '$(shortSha)'

steps:
  - checkout: self
    clean: true

  - task: NodeTool@0
    displayName: 'Use Node.js $(nodeVersion)'
    inputs:
      versionSpec: '$(nodeVersion)'

  - script: |
      npm install
    displayName: 'Instalar dependÃªncias'

  - script: |
      npm run build
    displayName: 'Build do frontend (Vite)'

  - task: Docker@2
    displayName: 'Build and push Docker image'
    inputs:
      command: 'buildAndPush'
      repository: '$(imageRepository)'
      dockerfile: '$(dockerfilePath)'
      containerRegistry: '$(containerRegistryServiceConnection)'
      tags: |
        $(imageTag)
      buildContext: '$(Build.SourcesDirectory)'
